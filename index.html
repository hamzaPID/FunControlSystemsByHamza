<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>AI & IoT Lab – PID Drone Playground</title>
  <style>
    body {
      margin: 0;
      font-family: system-ui, -apple-system, BlinkMacSystemFont, "Segoe UI", sans-serif;
      background: #f5f5f5;
    }
    #container {
      display: flex;
      height: 100vh;
    }
    #controls {
      width: 280px;
      background: #ffffff;
      border-right: 1px solid #ddd;
      padding: 16px;
      box-sizing: border-box;
    }
    #controls h1 {
      font-size: 18px;
      margin: 0 0 8px;
    }
    #controls p {
      font-size: 13px;
      margin: 4px 0;
    }
    .scenario {
      margin-top: 10px;
      padding: 8px;
      border-radius: 6px;
      background: #f0f4ff;
      font-size: 13px;
    }
    button {
      padding: 8px 10px;
      margin: 6px 0;
      width: 100%;
      border-radius: 6px;
      border: 1px solid #888;
      background: #fafafa;
      cursor: pointer;
      font-size: 13px;
    }
    button:hover {
      background: #e8f0ff;
    }
    .slider-group {
      margin-top: 8px;
    }
    .slider-group label {
      font-size: 13px;
      display: block;
      margin-bottom: 2px;
    }
    .slider-group input[type="range"] {
      width: 100%;
    }
    #visuals {
      flex: 1;
      display: flex;
      flex-direction: column;
      padding: 12px;
      box-sizing: border-box;
      gap: 8px;
    }
    canvas {
      background: #ffffff;
      border-radius: 8px;
      box-shadow: 0 1px 4px rgba(0,0,0,0.1);
    }
    #animCanvas {
      flex: 1;
    }
    #plotCanvas {
      flex: 1;
    }
    #infoText {
      font-size: 12px;
      color: #555;
      margin-top: 4px;
    }
  </style>
</head>
<body>
  <div id="container">
    <div id="controls">
      <h1>PID Drone Altitude</h1>
      <p>AI & IoT Lab – NUST CEME</p>
      <div class="scenario">
        <strong>Scenario:</strong> Drone altitude control<br />
        The drone should reach and hold a target height (1 m).
      </div>

      <button id="playBtn">▶ Play / Re-run Animation</button>

      <div class="slider-group">
        <label for="kp">K<sub>p</sub> (Proportional): <span id="kpVal"></span></label>
        <input type="range" id="kp" min="0" max="60" step="1" value="18" />
      </div>
      <div class="slider-group">
        <label for="ki">K<sub>i</sub> (Integral): <span id="kiVal"></span></label>
        <input type="range" id="ki" min="0" max="20" step="0.5" value="5" />
      </div>
      <div class="slider-group">
        <label for="kd">K<sub>d</sub> (Derivative): <span id="kdVal"></span></label>
        <input type="range" id="kd" min="0" max="10" step="0.2" value="4" />
      </div>

      <p id="infoText">
        Try increasing K<sub>p</sub> (faster but more overshoot),<br />
        K<sub>i</sub> (removes steady-state error), and<br />
        K<sub>d</sub> (adds damping, reduces overshoot).
      </p>
    </div>

    <div id="visuals">
      <canvas id="animCanvas"></canvas>
      <canvas id="plotCanvas"></canvas>
    </div>
  </div>

  <script>
    // ======== Global elements ========
    const animCanvas = document.getElementById("animCanvas");
    const plotCanvas = document.getElementById("plotCanvas");
    const animCtx = animCanvas.getContext("2d");
    const plotCtx = plotCanvas.getContext("2d");

    const kpSlider = document.getElementById("kp");
    const kiSlider = document.getElementById("ki");
    const kdSlider = document.getElementById("kd");
    const kpVal = document.getElementById("kpVal");
    const kiVal = document.getElementById("kiVal");
    const kdVal = document.getElementById("kdVal");
    const playBtn = document.getElementById("playBtn");

    // Canvas initial size
    function resizeCanvases() {
      const visuals = document.getElementById("visuals");
      // Make them responsive
      animCanvas.width = visuals.clientWidth - 16;
      animCanvas.height = Math.floor((visuals.clientHeight - 16) / 2);
      plotCanvas.width = visuals.clientWidth - 16;
      plotCanvas.height = Math.floor((visuals.clientHeight - 16) / 2);
    }
    window.addEventListener("resize", () => {
      resizeCanvases();
      // Redraw last simulation, if any
      if (currentSim) {
        drawFrame(currentSim, currentIndex);
      }
    });
    resizeCanvases();

    // ======== Simulation logic (drone altitude PID) ========
    function simulateDrone(Kp, Ki, Kd) {
      const T = 10;       // total simulation time [s]
      const dt = 0.02;    // time step
      const steps = Math.floor(T / dt) + 1;

      const t = new Array(steps);
      const y = new Array(steps);

      // Plant: m*z'' + c*z' + k*z = u
      const m = 1.0;
      const c = 1.2;
      const k = 0.5;
      const r = 1.0;   // target altitude (m)

      let z = 0;       // position
      let zdot = 0;    // velocity
      let eInt = 0;
      let ePrev = 0;

      for (let i = 0; i < steps; i++) {
        const ti = i * dt;
        t[i] = ti;

        const e = r - z;
        const de = (i === 0) ? 0 : (e - ePrev) / dt;
        eInt += e * dt;
        let u = Kp * e + Ki * eInt + Kd * de;

        // Saturation
        if (u > 50) u = 50;
        if (u < -50) u = -50;

        // Dynamics (forward Euler)
        const zddot = (u - c * zdot - k * z) / m;
        z += dt * zdot;
        zdot += dt * zddot;

        y[i] = z;
        ePrev = e;
      }

      return { t, y, r };
    }

    // ======== Animation state ========
    let currentSim = null;
    let currentIndex = 0;
    let animRequestId = null;

    function startAnimation(simData) {
      currentSim = simData;
      currentIndex = 0;
      if (animRequestId !== null) {
        cancelAnimationFrame(animRequestId);
      }
      animate();
    }

    function animate() {
      if (!currentSim) return;

      drawFrame(currentSim, currentIndex);

      currentIndex++;
      if (currentIndex < currentSim.t.length) {
        animRequestId = requestAnimationFrame(animate);
      }
    }

    // ======== Drawing ========
    function drawFrame(simData, idx) {
      const { t, y, r } = simData;
      const n = t.length;
      const k = Math.min(idx, n - 1);

      // Compute scales
      const yMin = Math.min(0, ...y);
      const yMax = Math.max(r * 1.2, ...y, 0.1);

      // ---- Draw animation (drone) ----
      const ctxA = animCtx;
      const W = animCanvas.width;
      const H = animCanvas.height;
      ctxA.clearRect(0, 0, W, H);

      // Ground
      const groundY = H * 0.85;
      ctxA.strokeStyle = "#333";
      ctxA.lineWidth = 3;
      ctxA.beginPath();
      ctxA.moveTo(W * 0.05, groundY);
      ctxA.lineTo(W * 0.95, groundY);
      ctxA.stroke();

      ctxA.fillStyle = "#555";
      ctxA.font = "12px sans-serif";
      ctxA.fillText("Ground", W * 0.06, groundY - 6);

      // Target altitude line
      const targetY =
        groundY - (r - yMin) / (yMax - yMin) * (H * 0.6);
      ctxA.strokeStyle = "#999";
      ctxA.setLineDash([5, 5]);
      ctxA.beginPath();
      ctxA.moveTo(W * 0.15, targetY);
      ctxA.lineTo(W * 0.85, targetY);
      ctxA.stroke();
      ctxA.setLineDash([]);
      ctxA.fillStyle = "#666";
      ctxA.fillText("Target altitude", W * 0.16, targetY - 6);

      // Current drone altitude
      const z = y[k];
      const droneY =
        groundY - (z - yMin) / (yMax - yMin) * (H * 0.6);
      const droneX = W * 0.5;
      const droneW = 60;
      const droneH = 25;

      ctxA.fillStyle = "#4da6ff";
      ctxA.strokeStyle = "#222";
      ctxA.lineWidth = 2;
      ctxA.beginPath();
      ctxA.roundRect(droneX - droneW / 2, droneY - droneH / 2, droneW, droneH, 6);
      ctxA.fill();
      ctxA.stroke();

      // Rotors
      ctxA.lineWidth = 3;
      ctxA.beginPath();
      ctxA.moveTo(droneX - droneW / 2, droneY - droneH / 2);
      ctxA.lineTo(droneX - droneW / 2 - 10, droneY - droneH / 2 - 12);
      ctxA.moveTo(droneX + droneW / 2, droneY - droneH / 2);
      ctxA.lineTo(droneX + droneW / 2 + 10, droneY - droneH / 2 - 12);
      ctxA.stroke();

      // Time label
      ctxA.fillStyle = "#000";
      ctxA.font = "12px sans-serif";
      ctxA.fillText(`t = ${t[k].toFixed(2)} s`, W * 0.7, H * 0.15);

      // ---- Draw altitude vs time plot ----
      const ctxP = plotCtx;
      const Wp = plotCanvas.width;
      const Hp = plotCanvas.height;
      ctxP.clearRect(0, 0, Wp, Hp);

      // Axes
      ctxP.strokeStyle = "#444";
      ctxP.lineWidth = 1;
      ctxP.beginPath();
      ctxP.moveTo(40, 10);
      ctxP.lineTo(40, Hp - 30);      // y-axis
      ctxP.lineTo(Wp - 10, Hp - 30); // x-axis
      ctxP.stroke();

      ctxP.fillStyle = "#000";
      ctxP.font = "12px sans-serif";
      ctxP.fillText("Altitude (m)", 6, 16);
      ctxP.fillText("Time (s)", Wp - 60, Hp - 10);

      // Reference line
      ctxP.strokeStyle = "#999";
      ctxP.setLineDash([4, 4]);
      ctxP.beginPath();
      for (let i = 0; i < n; i++) {
        const x = 40 + (t[i] / t[n - 1]) * (Wp - 60);
        const yPlot =
          (Hp - 30) -
          (r - yMin) / (yMax - yMin) * (Hp - 60);
        if (i === 0) ctxP.moveTo(x, yPlot);
        else ctxP.lineTo(x, yPlot);
      }
      ctxP.stroke();
      ctxP.setLineDash([]);

      // Output curve up to current index
      ctxP.strokeStyle = "#2a7ae2";
      ctxP.lineWidth = 2;
      ctxP.beginPath();
      for (let i = 0; i <= k; i++) {
        const x = 40 + (t[i] / t[n - 1]) * (Wp - 60);
        const yPlot =
          (Hp - 30) -
          (y[i] - yMin) / (yMax - yMin) * (Hp - 60);
        if (i === 0) ctxP.moveTo(x, yPlot);
        else ctxP.lineTo(x, yPlot);
      }
      ctxP.stroke();

      // Legend
      ctxP.fillStyle = "#000";
      ctxP.font = "11px sans-serif";
      ctxP.fillText("Reference", 50, 20);
      ctxP.fillText("Altitude", 50, 34);
      ctxP.strokeStyle = "#999";
      ctxP.beginPath();
      ctxP.moveTo(120, 16);
      ctxP.lineTo(150, 16);
      ctxP.stroke();
      ctxP.strokeStyle = "#2a7ae2";
      ctxP.beginPath();
      ctxP.moveTo(120, 30);
      ctxP.lineTo(150, 30);
      ctxP.stroke();
    }

    // ======== UI wiring ========
    function updateSliderLabels() {
      kpVal.textContent = parseFloat(kpSlider.value).toFixed(1);
      kiVal.textContent = parseFloat(kiSlider.value).toFixed(1);
      kdVal.textContent = parseFloat(kdSlider.value).toFixed(1);
    }

    kpSlider.addEventListener("input", updateSliderLabels);
    kiSlider.addEventListener("input", updateSliderLabels);
    kdSlider.addEventListener("input", updateSliderLabels);

    playBtn.addEventListener("click", () => {
      const Kp = parseFloat(kpSlider.value);
      const Ki = parseFloat(kiSlider.value);
      const Kd = parseFloat(kdSlider.value);
      const sim = simulateDrone(Kp, Ki, Kd);
      startAnimation(sim);
    });

    // Initialize labels and first run
    updateSliderLabels();
    const initialSim = simulateDrone(
      parseFloat(kpSlider.value),
      parseFloat(kiSlider.value),
      parseFloat(kdSlider.value)
    );
    startAnimation(initialSim);
  </script>
</body>
</html>
